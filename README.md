# xtensor Scalar Addition Benchmark

> **Warning**
> This is a **Work In Progress**. The benchmark scripts and analysis were partially generated by an LLM agent for rapid prototyping. Results have not been fully validated and should be independently verified before drawing conclusions.

Benchmarking `xt::xtensor` vs `xt::xtensor_fixed` for scalar addition across 18 compiler configurations.

## Quick Start

```bash
./scripts/build.sh --compiler=gcc-14 --xsimd=ON --jobs=8
./build_gcc14_xsimd/bench_xscalar
```

## Benchmark Kernel

```cpp
xt::noalias(result) = vec1 + static_cast<T>(1.0);
```

## Key Findings

| Size | Best Choice | Best Time | Worst Choice | Worst Time |
|------|-------------|-----------|--------------|------------|
| 1-2 | `xtensor_fixed` + no XSIMD + GCC | **0.2ns** | `xtensor_fixed` + XSIMD + GCC | ~10ns (50x slower) |
| 3-16 | `xtensor_fixed` + no XSIMD | ~2ns | `xtensor_fixed` + XSIMD + GCC | ~10ns (5x slower) |
| 32-64 | `xtensor` + no XSIMD + Clang | ~7-9ns | `xtensor_fixed` + no XSIMD + GCC | ~30-40ns (4x slower) |
| 256+ | `xtensor_fixed` + XSIMD + Clang | ~24-80ns | `xtensor_fixed` + no XSIMD + GCC | ~100-400ns (4-5x slower) |

### Key Observations

- **XSIMD hurts `xtensor_fixed` on GCC for small sizes**: 10ns overhead dominates computation
- **`gcc13_noxsimd_fixed` is catastrophic for large sizes**: Up to 400ns at size=1024
- **Clang without XSIMD has anomalies at sizes 8-9**: `xtensor_fixed` regresses to ~10-12ns

### Why?

- **Size 1-2**: Compiler optimizes `xtensor_fixed` to a single instruction
- **Small sizes + XSIMD**: Vectorization overhead exceeds computation time
- **Large sizes**: SIMD benefits outweigh fixed-size advantages

See [docs/reports/ISSUE_001_xsimd_svector_overhead.md](docs/reports/ISSUE_001_xsimd_svector_overhead.md) for detailed root cause analysis.

### Decision Guide

```
Size known at compile time?
├── YES, size ≤ 16   → xtensor_fixed, no XSIMD
├── YES, size > 256  → xtensor_fixed, XSIMD, Clang
└── NO               → xtensor, XSIMD, GCC
```

## Configurations Tested

**Compilers**: GCC 11-14, Clang 16-20
**XSIMD**: ON / OFF
**Sizes**: 1-10, 16, 32, 64, 128, 256, 512, 1024

## Project Structure

```
├── src/                    # Source code
│   └── bench_xscalar.cpp   # Benchmark source
├── scripts/                # Automation scripts
│   ├── build.sh            # Multi-compiler build script
│   └── run_vtune_analysis.sh  # VTune profiling
├── docs/                   # Documentation
│   ├── BENCHMARK_REPORT.md # Full analysis with data tables
│   └── reports/            # Performance issue reports
└── CMakeLists.txt          # CMake configuration
```

## Build Options

```bash
./scripts/build.sh --compiler=clang-18 --xsimd=OFF --jobs=8 --clean
./scripts/build.sh --list  # Show all builds
```
